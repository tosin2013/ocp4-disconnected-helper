---
# Prerequisites:
## Modify the inventory file to reflect your environment
## The user must have password-less sudo access
## The user must have password-less ssh access to the remote hosts

- name: Install Red Hat Quay Mirror Registry
  hosts: quay
  become: true
  gather_facts: true

  vars:
    # Required - Set the hostname and configuration
    quay_hostname: quay
    base_domain: example.com
    quay_version: "3.9.6"
    quay_root_dir: /opt/quay
    quay_storage_dir: /var/lib/quay
    
    # Database configuration
    postgres_version: "13"
    postgres_password: "{{ lookup('password', '/dev/null length=32 chars=ascii_letters,digits') }}"
    
    # SSL Configuration
    enable_ssl: true
    ssl_cert_dir: /opt/quay/ssl
    enable_certbot: false
    certbot_email: "admin@example.com"

    # System packages
    quay_server_pkgs:
      - podman
      - postgresql-server
      - postgresql-contrib
      - openssl
      - firewalld
      - python3-pip
      - certbot
      - git
      - policycoreutils-python-utils
      - httpd-tools
      - nano
      - cockpit
      - cockpit-podman

  tasks:
    - name: Install required packages
      ansible.builtin.package:
        name: "{{ quay_server_pkgs }}"
        state: present

    - name: Enable and start required services
      ansible.builtin.service:
        name: "{{ item }}"
        state: started
        enabled: true
      loop:
        - firewalld
        - podman
        - cockpit.socket

    - name: Configure firewall
      ansible.posix.firewalld:
        port: "{{ item }}"
        permanent: true
        state: enabled
        immediate: true
      loop:
        - 80/tcp
        - 443/tcp
        - 5432/tcp  # PostgreSQL
        - 8443/tcp  # Quay API
        - 8080/tcp  # Quay web UI

    - name: Create Quay directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - "{{ quay_root_dir }}"
        - "{{ quay_storage_dir }}"
        - "{{ quay_root_dir }}/config"
        - "{{ ssl_cert_dir }}"

    - name: Initialize PostgreSQL database
      block:
        - name: Initialize PostgreSQL database
          ansible.builtin.command:
            cmd: postgresql-setup --initdb
            creates: /var/lib/pgsql/data/postgresql.conf

        - name: Start and enable PostgreSQL
          ansible.builtin.service:
            name: postgresql
            state: started
            enabled: true

        - name: Create Quay database
          become: true
          become_user: postgres
          ansible.builtin.postgresql_db:
            name: quay
            encoding: UTF-8
            template: template0

        - name: Create Quay database user
          become: true
          become_user: postgres
          ansible.builtin.postgresql_user:
            db: quay
            name: quay
            password: "{{ postgres_password }}"
            priv: ALL

    - name: Setup SSL certificates
      when: enable_ssl | bool
      block:
        - name: Generate self-signed certificate
          when: not enable_certbot | bool
          ansible.builtin.shell:
            cmd: |
              openssl req -new -newkey rsa:4096 -days 365 -nodes -x509 \
                -subj "/C=US/ST=State/L=City/O=Organization/CN={{ quay_hostname }}.{{ base_domain }}" \
                -keyout {{ ssl_cert_dir }}/ssl.key -out {{ ssl_cert_dir }}/ssl.cert
            creates: "{{ ssl_cert_dir }}/ssl.cert"

        - name: Request Let's Encrypt certificate
          when: enable_certbot | bool
          ansible.builtin.shell:
            cmd: |
              certbot certonly --standalone -n \
                -d {{ quay_hostname }}.{{ base_domain }} \
                --email {{ certbot_email }} --agree-tos
            creates: "/etc/letsencrypt/live/{{ quay_hostname }}.{{ base_domain }}/fullchain.pem"

    - name: Pull Quay container images
      containers.podman.podman_image:
        name: "{{ item }}"
      loop:
        - "registry.redhat.io/quay/quay-rhel8:v{{ quay_version }}"
        - "registry.redhat.io/rhel8/postgresql-13:latest"

    - name: Generate Quay configuration
      ansible.builtin.template:
        src: templates/quay-config.yaml.j2
        dest: "{{ quay_root_dir }}/config/config.yaml"
        mode: '0644'

    - name: Generate Quay systemd service
      ansible.builtin.template:
        src: templates/quay-container.service.j2
        dest: /etc/systemd/system/quay-container.service
        mode: '0644'

    - name: Start and enable Quay service
      ansible.builtin.service:
        name: quay-container
        state: started
        enabled: true
        daemon_reload: true

    - name: Wait for Quay to be ready
      ansible.builtin.uri:
        url: "https://{{ quay_hostname }}.{{ base_domain }}"
        validate_certs: false
      register: result
      until: result.status == 200
      retries: 60
      delay: 5

    - name: Display Quay setup information
      ansible.builtin.debug:
        msg:
          - "==================================================="
          - "Quay Mirror Registry Setup Complete!"
          - "==================================================="
          - "Access Quay at: https://{{ quay_hostname }}.{{ base_domain }}"
          - "Default admin credentials will be created on first access"
          - "==================================================="
