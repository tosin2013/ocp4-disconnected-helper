---
# Prerequisites:
## Modify the inventory file to reflect your environment
## The user must have password-less sudo access
## The user must have password-less sh access to the remote hosts
## You need a user to push to your remote registry

- name: Push a local set of oc-mirror packed TAR files to a remote registry
  hosts: localhost
  gather_facts: true
  become: true

  tasks:
    - name: Make sure that the root user has /usr/local/bin in its PATH
      block:
        - name: Check if /usr/local/bin is already defined
          ansible.builtin.lineinfile:
            state: absent
            path: "/root/.bashrc"
            regexp: "/usr/local/bin"
          check_mode: true
          changed_when: false
          register: path_check

        - name: Define /usr/local/bin if undefined
          ansible.builtin.lineinfile:
            state: present
            path: "/root/.bashrc"
            line: "export PATH=$PATH:/usr/local/bin"
          when: "path_check.found == 0"

    - name: Get path to oc command
      ansible.builtin.command:
        cmd: which oc
      environment:
        PATH: "{{ ansible_env.PATH }}:/usr/local/bin"
      register: oc_path
      changed_when: false

    - name: Create the Container Registry Config directory
      ansible.builtin.file:
        path: "{{ target_registry_auth_path }}"
        state: directory
        owner: "{{ target_registry_auth_path_user }}"
        group: "{{ target_registry_auth_path_group }}"
        mode: "0o700"

    - name: Create the authentication file for the registry
      ansible.builtin.template:
        src: templates/registry_auth.json.j2
        dest: "{{ target_registry_auth_path }}/config.json"
        mode: "0o600"

    - name: Generate Basic Auth Token for each registry
      ansible.builtin.set_fact:
        auth_token: "{{ (item.username + ':' + item.password) | b64encode }}"
      loop: "{{ registries }}"
      loop_control:
        loop_var: item
      when: "item.registry_type == 'harbor'"

    - name: Create Harbor Projects
      ansible.builtin.uri:
        url: "https://{{ item.server }}/api/v2.0/projects"
        method: POST
        headers:
          Authorization: "Basic {{ auth_token }}"
          Content-Type: "application/json"
        body_format: json
        status_code: [201, 409]  # 409 means project already exists
        validate_certs: false
        body: |
          {
            "project_name": "{{ item.path }}",
            "metadata": {
              "public": true
            },
            "storage_limit": -1,
            "registry_id": null
          }
      loop: "{{ registries }}"
      loop_control:
        loop_var: item
      when: "item.registry_type == 'harbor'"
      failed_when: false

    - name: View Output of oc-mirror Log
      ansible.builtin.debug:
        msg: "tail -f {{ lookup('file', '/tmp/oc-mirror-' + item.path + '.log') }}"
      loop: "{{ registries }}"
      loop_control:
        loop_var: item
      when: "item.registry_type == 'harbor'"

    - name: Push the mirror to the remote registry
      delegate_to: localhost
      ansible.builtin.shell:
        cmd: |-
          set -o pipefail
          oc-mirror --from={{ source_mirror_path }}/{{ mirror_tar_file }} \
            docker://{{ item.server }}/{{ item.path | default(omit) }} \
            --dest-skip-tls --max-per-registry=2 2>&1 | tee /tmp/oc-mirror-{{ item.path }}.log
      args:
        executable: /bin/bash
        creates: "/opt/images/oc-mirror-workspace/results-{{ lookup('pipe', 'date +%Y%m%d-%H%M%S') }}"
      environment:
        PATH: "{{ ansible_env.PATH }}:/usr/local/bin"
      register: mirror_output
      loop: "{{ registries }}"
      loop_control:
        loop_var: item
      changed_when: "'Writing ICSP manifests to' in mirror_output.stdout"

    - name: Verify push completion
      ansible.builtin.assert:
        that: "'error' not in item.stdout_lower"
        fail_msg: "Mirror push failed for {{ item.item.server }}/{{ item.item.path }}"
      loop: "{{ push_status.results }}"
      loop_control:
        loop_var: item

    - name: Wait for repository to be available in registry
      ansible.builtin.uri:
        url: "https://{{ item.server }}/v2/{{ item.path }}/tags/list"
        method: GET
        validate_certs: false
        status_code: [200, 404]
        url_username: "{{ item.username }}"
        url_password: "{{ item.password }}"
      register: repo_check
      until: "repo_check.status == 200"
      retries: 30
      delay: 10
      loop: "{{ registries }}"
      loop_control:
        loop_var: item

    - name: Calculate local checksums
      ansible.builtin.command:
        cmd: "sha256sum {{ source_mirror_path }}/{{ mirror_tar_file }}"
      register: local_checksums
      changed_when: false

    - name: Get remote checksums
      ansible.builtin.uri:
        url: >-
          https://{{ registry.server }}/api/v1/repository/{{ registry.path }}/
          {{ mirror_tar_file | basename | replace('.tar', '') }}/tag
        method: GET
        status_code: 200
        return_content: true
        validate_certs: false
      register: registry_checksums
      loop: "{{ registries }}"
      loop_control:
        loop_var: registry
      when: "registry.registry_type == 'quay'"

    - name: Verify checksums
      ansible.builtin.assert:
        that: >-
          local_checksums.stdout | regex_search('(\\w+)\\s+.*', '\\1') ==
          (registry_checksums.json | from_json)[0].manifest_digest | regex_search('sha256:(\\w+)', '\\1')
        fail_msg: >-
          Checksum verification failed for {{ registry.server }}/{{ registry.path }}/
          {{ mirror_tar_file | basename | replace('.tar', '') }}
      loop: "{{ registries }}"
      loop_control:
        loop_var: registry
      when: "registry.registry_type == 'quay'"

    - name: Get mirror results path
      ansible.builtin.set_fact:
        mirror_results_path: "{{ source_mirror_path }}/oc-mirror-workspace/results-{{ lookup('pipe', 'date +%s') }}"

    - name: Create mirror results directory
      ansible.builtin.file:
        path: "{{ mirror_results_path }}"
        state: directory
        mode: "0o755"

    - name: Display mirror results location
      ansible.builtin.debug:
        msg: "Mirror results are located at {{ mirror_results_path }}"
