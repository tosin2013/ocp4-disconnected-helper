#!/bin/bash
# ICSP Application Script for Registry Passthrough Mode
# Generated by ocp4-disconnected-helper

set -euo pipefail

# Configuration
ICSP_FILE="{{ icsp_file }}"
OC_CONFIG="{{ oc_config_path | default(ansible_env.HOME + '/.kube/config') }}"
NAMESPACE="{{ icsp_namespace | default('openshift-config') }}"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Logging function
log() {
    echo -e "${GREEN}[$(date +'%Y-%m-%d %H:%M:%S')]${NC} $1"
}

error() {
    echo -e "${RED}[$(date +'%Y-%m-%d %H:%M:%S')] ERROR:${NC} $1" >&2
}

warn() {
    echo -e "${YELLOW}[$(date +'%Y-%m-%d %H:%M:%S')] WARNING:${NC} $1" >&2
}

# Check prerequisites
check_prerequisites() {
    log "Checking prerequisites..."
    
    # Check if oc command is available
    if ! command -v oc &> /dev/null; then
        error "oc command not found. Please install OpenShift CLI."
        exit 1
    fi
    
    # Check if ICSP file exists
    if [[ ! -f "$ICSP_FILE" ]]; then
        error "ICSP file not found: $ICSP_FILE"
        exit 1
    fi
    
    # Check if kubeconfig exists
    if [[ ! -f "$OC_CONFIG" ]]; then
        error "Kubeconfig not found: $OC_CONFIG"
        exit 1
    fi
    
    # Test cluster connectivity
    if ! oc cluster-info &> /dev/null; then
        error "Cannot connect to OpenShift cluster"
        exit 1
    fi
    
    log "Prerequisites check passed"
}

# Validate ICSP YAML
validate_icsp() {
    log "Validating ICSP YAML..."
    
    if ! oc apply --dry-run=client -f "$ICSP_FILE" &> /dev/null; then
        error "ICSP YAML validation failed"
        oc apply --dry-run=client -f "$ICSP_FILE"
        exit 1
    fi
    
    log "ICSP YAML validation passed"
}

# Check existing ICSP policies
check_existing_icsp() {
    log "Checking existing ICSP policies..."
    
    local existing_icsp
    existing_icsp=$(oc get imagecontentsourcepolicy -o jsonpath='{.items[*].metadata.name}' 2>/dev/null || echo "")
    
    if [[ -n "$existing_icsp" ]]; then
        warn "Existing ICSP policies found: $existing_icsp"
        warn "New ICSP will be added alongside existing policies"
        log "Existing policies will remain active"
    else
        log "No existing ICSP policies found"
    fi
}

# Apply ICSP policy
apply_icsp() {
    log "Applying ICSP policy from: $ICSP_FILE"
    
    if oc apply -f "$ICSP_FILE"; then
        log "ICSP policy applied successfully"
    else
        error "Failed to apply ICSP policy"
        exit 1
    fi
}

# Verify ICSP application
verify_icsp() {
    log "Verifying ICSP policy application..."
    
    local icsp_name
    icsp_name=$(oc get -f "$ICSP_FILE" -o jsonpath='{.metadata.name}' 2>/dev/null || echo "")
    
    if [[ -z "$icsp_name" ]]; then
        error "Failed to retrieve ICSP policy name"
        exit 1
    fi
    
    # Check if ICSP is properly applied
    local icsp_status
    icsp_status=$(oc get imagecontentsourcepolicy "$icsp_name" -o jsonpath='{.status.conditions[0].status}' 2>/dev/null || echo "")
    
    if [[ "$icsp_status" == "True" ]]; then
        log "ICSP policy '$icsp_name' is properly applied and active"
    else
        warn "ICSP policy '$icsp_name' applied but status verification inconclusive"
        log "This is normal for newly applied policies"
    fi
    
    # Display ICSP details
    log "ICSP Policy Details:"
    oc get imagecontentsourcepolicy "$icsp_name" -o yaml | grep -A 20 "repositoryDigestMirrors:" || true
}

# Display mirror configuration
display_mirror_config() {
    log "Displaying mirror configuration from ICSP..."
    
    local mirror_count
    mirror_count=$(oc get -f "$ICSP_FILE" -o jsonpath='{.spec.repositoryDigestMirrors[*].source}' | wc -w || echo "0")
    
    log "Number of mirror configurations: $mirror_count"
    
    # Show source registries being mirrored
    local sources
    sources=$(oc get -f "$ICSP_FILE" -o jsonpath='{.spec.repositoryDigestMirrors[*].source}' | tr ' ' '\n' | sort -u || echo "")
    
    if [[ -n "$sources" ]]; then
        log "Source registries being mirrored:"
        echo "$sources" | while read -r source; do
            log "  - $source"
        done
    fi
}

# Main execution
main() {
    log "Starting ICSP application process"
    log "ICSP File: $ICSP_FILE"
    
    check_prerequisites
    validate_icsp
    check_existing_icsp
    apply_icsp
    verify_icsp
    display_mirror_config
    
    log "ICSP application completed successfully"
    log ""
    log "Next steps:"
    log "1. Wait for Machine Config Operator to apply changes (may take 10-15 minutes)"
    log "2. Monitor node updates with: 'oc get mcp'"
    log "3. Test image pull redirection with: 'oc image pull quay.io/centos/centos:stream8'"
    log "4. Verify registry connectivity with validation playbook"
}

# Execute main function
main "$@"
