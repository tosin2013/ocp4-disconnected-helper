---
# Setup Certificates for Disconnected Environment
# ADR Reference: ADR 0016 - Trusted Certificate Management
#
# This playbook generates a Certificate Authority (CA) and server certificates
# for use with registries and other services in disconnected environments.
#
# Usage:
#   ansible-playbook -i inventory setup-certificates.yml
#   ansible-playbook -i inventory setup-certificates.yml -e "regenerate_ca=true"
#
# Variables (see extra_vars/certificates-example.yml):
#   cert_organization: Organization name for certificates
#   cert_common_name: Common name for CA certificate
#   registry_hostname: Hostname for registry certificate
#   cert_validity_days: Validity period for CA (default: 3650)
#   server_cert_validity_days: Validity period for server certs (default: 365)

- name: Setup TLS Certificates for Disconnected Environment
  hosts: localhost
  gather_facts: true
  become: true
  
  vars:
    # Certificate Authority settings
    cert_organization: "Disconnected Lab"
    cert_organizational_unit: "OpenShift Infrastructure"
    cert_country: "US"
    cert_state: "Virginia"
    cert_locality: "Reston"
    cert_common_name: "Disconnected Environment CA"
    cert_validity_days: 3650  # 10 years for CA
    server_cert_validity_days: 825  # ~2.25 years for server certs (max recommended)
    
    # Paths
    ca_base_path: "/etc/pki/disconnected-ca"
    ca_private_path: "{{ ca_base_path }}/private"
    ca_certs_path: "{{ ca_base_path }}/certs"
    ca_newcerts_path: "{{ ca_base_path }}/newcerts"
    
    # Registry settings (can be overridden)
    registry_hostname: "{{ ansible_fqdn }}"
    registry_ip: "{{ ansible_default_ipv4.address | default('127.0.0.1') }}"
    registry_port: 8443
    registry_cert_path: "/etc/pki/registry"
    
    # Additional SANs for registry certificate
    additional_registry_hostnames: []
    additional_registry_ips: []
    
    # Control flags
    regenerate_ca: false
    regenerate_registry_cert: false
    
  tasks:
    # =========================================================================
    # Prerequisites
    # =========================================================================
    - name: Install required packages
      ansible.builtin.package:
        name:
          - openssl
          - ca-certificates
        state: present
        disable_gpg_check: true
      ignore_errors: true
      register: pkg_install

    - name: Check if openssl is available
      ansible.builtin.command:
        cmd: which openssl
      register: openssl_check
      changed_when: false
      failed_when: openssl_check.rc != 0

    # =========================================================================
    # CA Directory Structure
    # =========================================================================
    - name: Create CA directory structure
      ansible.builtin.file:
        path: "{{ item.path }}"
        state: directory
        mode: "{{ item.mode }}"
        owner: root
        group: root
      loop:
        - { path: "{{ ca_base_path }}", mode: "0755" }
        - { path: "{{ ca_private_path }}", mode: "0700" }
        - { path: "{{ ca_certs_path }}", mode: "0755" }
        - { path: "{{ ca_newcerts_path }}", mode: "0755" }
        - { path: "{{ registry_cert_path }}", mode: "0755" }

    - name: Initialize CA serial file
      ansible.builtin.copy:
        content: "1000"
        dest: "{{ ca_base_path }}/serial"
        mode: "0644"
        force: false

    - name: Initialize CA index file
      ansible.builtin.file:
        path: "{{ ca_base_path }}/index.txt"
        state: touch
        mode: "0644"
        modification_time: preserve
        access_time: preserve

    # =========================================================================
    # CA Configuration
    # =========================================================================
    - name: Create OpenSSL CA configuration
      ansible.builtin.copy:
        dest: "{{ ca_base_path }}/openssl-ca.cnf"
        mode: "0644"
        content: |
          # OpenSSL CA Configuration
          # Generated by setup-certificates.yml
          
          [ ca ]
          default_ca = CA_default
          
          [ CA_default ]
          dir               = {{ ca_base_path }}
          certs             = $dir/certs
          new_certs_dir     = $dir/newcerts
          database          = $dir/index.txt
          serial            = $dir/serial
          private_key       = $dir/private/ca.key
          certificate       = $dir/certs/ca.crt
          default_days      = {{ server_cert_validity_days }}
          default_md        = sha256
          preserve          = no
          policy            = policy_loose
          
          [ policy_loose ]
          countryName             = optional
          stateOrProvinceName     = optional
          localityName            = optional
          organizationName        = optional
          organizationalUnitName  = optional
          commonName              = supplied
          emailAddress            = optional
          
          [ req ]
          default_bits        = 4096
          distinguished_name  = req_distinguished_name
          string_mask         = utf8only
          default_md          = sha256
          x509_extensions     = v3_ca
          
          [ req_distinguished_name ]
          countryName                     = Country Name (2 letter code)
          stateOrProvinceName             = State or Province Name
          localityName                    = Locality Name
          0.organizationName              = Organization Name
          organizationalUnitName          = Organizational Unit Name
          commonName                      = Common Name
          
          [ v3_ca ]
          subjectKeyIdentifier = hash
          authorityKeyIdentifier = keyid:always,issuer
          basicConstraints = critical, CA:true, pathlen:0
          keyUsage = critical, digitalSignature, cRLSign, keyCertSign
          
          [ server_cert ]
          basicConstraints = CA:FALSE
          nsCertType = server
          nsComment = "OpenSSL Generated Server Certificate"
          subjectKeyIdentifier = hash
          authorityKeyIdentifier = keyid,issuer:always
          keyUsage = critical, digitalSignature, keyEncipherment
          extendedKeyUsage = serverAuth

    # =========================================================================
    # Generate CA Certificate
    # =========================================================================
    - name: Check if CA already exists
      ansible.builtin.stat:
        path: "{{ ca_private_path }}/ca.key"
      register: ca_key_stat

    - name: Generate CA private key
      ansible.builtin.command:
        cmd: >
          openssl genrsa -out {{ ca_private_path }}/ca.key 4096
        creates: "{{ ca_private_path }}/ca.key"
      when: not ca_key_stat.stat.exists or regenerate_ca

    - name: Set CA private key permissions
      ansible.builtin.file:
        path: "{{ ca_private_path }}/ca.key"
        mode: "0400"
        owner: root
        group: root

    - name: Generate CA certificate
      ansible.builtin.command:
        cmd: >
          openssl req -new -x509 -days {{ cert_validity_days }}
          -key {{ ca_private_path }}/ca.key
          -out {{ ca_certs_path }}/ca.crt
          -config {{ ca_base_path }}/openssl-ca.cnf
          -subj "/C={{ cert_country }}/ST={{ cert_state }}/L={{ cert_locality }}/O={{ cert_organization }}/OU={{ cert_organizational_unit }}/CN={{ cert_common_name }}"
        creates: "{{ ca_certs_path }}/ca.crt"
      when: not ca_key_stat.stat.exists or regenerate_ca

    - name: Display CA certificate info
      ansible.builtin.command:
        cmd: openssl x509 -in {{ ca_certs_path }}/ca.crt -noout -subject -dates
      register: ca_info
      changed_when: false

    - name: Show CA certificate details
      ansible.builtin.debug:
        msg: "{{ ca_info.stdout_lines }}"

    # =========================================================================
    # Generate Registry Server Certificate
    # =========================================================================
    - name: Check if registry certificate exists
      ansible.builtin.stat:
        path: "{{ registry_cert_path }}/registry.crt"
      register: registry_cert_stat

    - name: Build SAN list for registry certificate
      ansible.builtin.set_fact:
        registry_san_list: |
          DNS:{{ registry_hostname }}
          DNS:localhost
          {% for hostname in additional_registry_hostnames %}
          DNS:{{ hostname }}
          {% endfor %}
          IP:{{ registry_ip }}
          IP:127.0.0.1
          {% for ip in additional_registry_ips %}
          IP:{{ ip }}
          {% endfor %}

    - name: Create registry certificate OpenSSL config
      ansible.builtin.copy:
        dest: "{{ registry_cert_path }}/registry-openssl.cnf"
        mode: "0644"
        content: |
          [ req ]
          default_bits       = 4096
          distinguished_name = req_distinguished_name
          req_extensions     = req_ext
          prompt             = no
          
          [ req_distinguished_name ]
          C  = {{ cert_country }}
          ST = {{ cert_state }}
          L  = {{ cert_locality }}
          O  = {{ cert_organization }}
          OU = {{ cert_organizational_unit }}
          CN = {{ registry_hostname }}
          
          [ req_ext ]
          subjectAltName = @alt_names
          
          [ alt_names ]
          DNS.1 = {{ registry_hostname }}
          DNS.2 = localhost
          {% for hostname in additional_registry_hostnames %}
          DNS.{{ loop.index + 2 }} = {{ hostname }}
          {% endfor %}
          IP.1 = {{ registry_ip }}
          IP.2 = 127.0.0.1
          {% for ip in additional_registry_ips %}
          IP.{{ loop.index + 2 }} = {{ ip }}
          {% endfor %}
          
          [ v3_ext ]
          basicConstraints       = CA:FALSE
          keyUsage               = critical, digitalSignature, keyEncipherment
          extendedKeyUsage       = serverAuth
          subjectAltName         = @alt_names
          subjectKeyIdentifier   = hash
          authorityKeyIdentifier = keyid,issuer

    - name: Generate registry private key
      ansible.builtin.command:
        cmd: openssl genrsa -out {{ registry_cert_path }}/registry.key 4096
        creates: "{{ registry_cert_path }}/registry.key"
      when: not registry_cert_stat.stat.exists or regenerate_registry_cert

    - name: Set registry private key permissions
      ansible.builtin.file:
        path: "{{ registry_cert_path }}/registry.key"
        mode: "0400"
        owner: root
        group: root

    - name: Generate registry CSR
      ansible.builtin.command:
        cmd: >
          openssl req -new
          -key {{ registry_cert_path }}/registry.key
          -out {{ registry_cert_path }}/registry.csr
          -config {{ registry_cert_path }}/registry-openssl.cnf
      when: not registry_cert_stat.stat.exists or regenerate_registry_cert

    - name: Sign registry certificate with CA
      ansible.builtin.command:
        cmd: >
          openssl x509 -req
          -in {{ registry_cert_path }}/registry.csr
          -CA {{ ca_certs_path }}/ca.crt
          -CAkey {{ ca_private_path }}/ca.key
          -CAcreateserial
          -out {{ registry_cert_path }}/registry.crt
          -days {{ server_cert_validity_days }}
          -sha256
          -extfile {{ registry_cert_path }}/registry-openssl.cnf
          -extensions v3_ext
      when: not registry_cert_stat.stat.exists or regenerate_registry_cert

    - name: Display registry certificate info
      ansible.builtin.command:
        cmd: openssl x509 -in {{ registry_cert_path }}/registry.crt -noout -subject -dates -ext subjectAltName
      register: registry_cert_info
      changed_when: false

    - name: Show registry certificate details
      ansible.builtin.debug:
        msg: "{{ registry_cert_info.stdout_lines }}"

    # =========================================================================
    # Trust CA System-Wide
    # =========================================================================
    - name: Copy CA to system trust store (RHEL/CentOS)
      ansible.builtin.copy:
        src: "{{ ca_certs_path }}/ca.crt"
        dest: /etc/pki/ca-trust/source/anchors/disconnected-ca.crt
        remote_src: true
        mode: "0644"
      when: ansible_os_family == "RedHat"
      notify: Update CA trust

    - name: Copy CA to system trust store (Debian/Ubuntu)
      ansible.builtin.copy:
        src: "{{ ca_certs_path }}/ca.crt"
        dest: /usr/local/share/ca-certificates/disconnected-ca.crt
        remote_src: true
        mode: "0644"
      when: ansible_os_family == "Debian"
      notify: Update CA trust Debian

    # =========================================================================
    # Create Combined Certificate Files
    # =========================================================================
    - name: Create certificate chain (cert + CA)
      ansible.builtin.shell: |
        cat {{ registry_cert_path }}/registry.crt {{ ca_certs_path }}/ca.crt > {{ registry_cert_path }}/registry-chain.crt
      args:
        creates: "{{ registry_cert_path }}/registry-chain.crt"

    - name: Set certificate chain permissions
      ansible.builtin.file:
        path: "{{ registry_cert_path }}/registry-chain.crt"
        mode: "0644"

    # =========================================================================
    # Summary
    # =========================================================================
    - name: Display certificate locations
      ansible.builtin.debug:
        msg:
          - "=============================================="
          - "Certificate Generation Complete"
          - "=============================================="
          - ""
          - "CA Certificate:     {{ ca_certs_path }}/ca.crt"
          - "CA Private Key:     {{ ca_private_path }}/ca.key"
          - ""
          - "Registry Certificate: {{ registry_cert_path }}/registry.crt"
          - "Registry Key:         {{ registry_cert_path }}/registry.key"
          - "Registry Chain:       {{ registry_cert_path }}/registry-chain.crt"
          - ""
          - "CA has been added to system trust store."
          - ""
          - "To use with mirror-registry:"
          - "  ./mirror-registry install \\"
          - "    --quayHostname {{ registry_hostname }} \\"
          - "    --sslCert {{ registry_cert_path }}/registry.crt \\"
          - "    --sslKey {{ registry_cert_path }}/registry.key"
          - ""
          - "To use with Harbor:"
          - "  Copy certificates to Harbor data directory"
          - ""
          - "=============================================="

  handlers:
    - name: Update CA trust
      ansible.builtin.command:
        cmd: update-ca-trust extract

    - name: Update CA trust Debian
      ansible.builtin.command:
        cmd: update-ca-certificates
