---
- name: Check if VM exists
  shell: sudo virsh dominfo {{ vm_name }} || true
  register: vm_exists
  changed_when: false

- name: Destroy and undefine existing VM
  shell: |
    sudo virsh destroy {{ vm_name }} || true
    sudo virsh undefine {{ vm_name }} || true
  when: vm_exists.rc == 0

- name: Remove existing VM images
  file:
    path: "{{ item }}"
    state: absent
  with_items:
    - "/var/lib/libvirt/images/{{ vm_name }}.qcow2"
    - "/var/lib/libvirt/images/{{ vm_name }}-cidata.iso"
  become: true
  
- name: Create inventory directory
  file:
    path: "{{ playbook_dir }}/inventory"
    state: directory
    mode: '0755'
  become: true

- name: Clone RHEL8 image for VM
  command: >-
    sudo qemu-img create -f qcow2 
    -F qcow2 
    -b /var/lib/libvirt/images/rhel8 
    /var/lib/libvirt/images/{{ vm_name }}.qcow2 
    {{ vm_disk_size | default('250') }}G

- name: Set registry-specific packages
  set_fact:
    selected_packages: "{{ lookup('vars', registry_type + '_packages') }}"

- name: Generate cloud-init config
  template:
    src: "cloud-init-{{ registry_type }}.yml.j2"
    dest: "/tmp/user-data-{{ vm_name }}"
    mode: '0644'
  vars:
    packages: "{{ selected_packages }}"
    
- name: Create cloud-init ISO
  shell: |
    TMPDIR=$(mktemp -d)
    sudo cp /tmp/user-data-{{ vm_name }} $TMPDIR/user-data
    sudo sh -c "echo '#cloud-config' > $TMPDIR/meta-data"
    sudo genisoimage -output /var/lib/libvirt/images/{{ vm_name }}-cidata.iso -volid cidata -joliet -r $TMPDIR/user-data $TMPDIR/meta-data
    rm -rf $TMPDIR
    rm -f /tmp/user-data-{{ vm_name }}
  args:
    executable: /bin/bash
  become: true
    
- name: Define VM
  raw: >-
    sudo virt-install --connect qemu:///system 
    --name {{ vm_name }} 
    --ram {{ vm_memory | default('8192') }} 
    --vcpus {{ vm_cpus | default('4') }} 
    --import
    --disk path=/var/lib/libvirt/images/{{ vm_name }}.qcow2,format=qcow2
    --disk path=/var/lib/libvirt/images/{{ vm_name }}-cidata.iso,device=cdrom
    --network network=default 
    --os-variant rhel8.0
    --graphics vnc 
    --noautoconsole

- name: Wait for VM IP address
  shell: |
    for i in {1..30}; do
      ip=$(sudo virsh domifaddr {{ vm_name }} | grep -oE '([0-9]{1,3}\.){3}[0-9]{1,3}/[0-9]{1,2}' || true)
      if [ ! -z "$ip" ]; then
        echo $ip | cut -d'/' -f1
        exit 0
      fi
      sleep 2
    done
    exit 1
  register: vm_ip
  changed_when: false

- name: Create VM inventory file
  copy:
    dest: "{{ playbook_dir }}/inventory/{{ inventory_file | default(vm_name) }}"
    content: |
      [{{ inventory_group | default(vm_name) }}]
      {{ vm_ip.stdout }} ansible_user=root ansible_ssh_pass=redhat

      [all:vars]
      ansible_ssh_common_args='-o StrictHostKeyChecking=no'
  become: true

- name: Wait for SSH connection
  wait_for:
    host: "{{ vm_ip.stdout }}"
    port: 22
    delay: 30
    timeout: 300
  delegate_to: localhost

- name: Wait for cloud-init to complete
  pause:
    seconds: 30
  delegate_to: localhost
